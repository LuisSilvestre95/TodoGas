<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO GAS SYR S.A.S - Sistema de Cálculo de Redes de Gas</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF para generación de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF-AutoTable para generación avanzada de tablas en PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
    <!-- html2canvas (mantenido para captura de gráficos si es necesario, no para página completa) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Definición de variables CSS para colores corporativos y de estado */
        :root {
            --primary-dark: #0d2b4e;
            --primary: #1a4b8c;
            --primary-light: #2a75d8;
            --secondary: #2a9d8f;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #2196f3;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
        }

        /* Estilos generales del cuerpo de la página */
        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }

        /* Estilo para el logo en la barra de navegación */
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            letter-spacing: 0.5px;
        }

        /* Estilos base para las tarjetas (cards) */
        .card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }

        /* Efecto hover para las tarjetas */
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        /* Estilos para el encabezado de las tarjetas */
        .card-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 0.75rem 0.75rem 0 0 !important;
            font-weight: 600;
            padding: 1rem 1.5rem;
            border-bottom: none;
        }

        .card-header h5 {
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Estilos para filas de segmentos aprobados, rechazados y con advertencia en la tabla */
        .segment-approved {
            background-color: rgba(76, 175, 80, 0.05);
            border-left: 4px solid var(--success);
        }

        .segment-rejected {
            background-color: rgba(244, 67, 54, 0.05);
            border-left: 4px solid var(--danger);
        }

        .segment-approved-with-warning {
            background-color: rgba(255, 193, 7, 0.08);
            border-left: 4px solid var(--warning);
        }

        /* Estilos para insignias de estado (Aprobado/Rechazado/Advertencia) */
        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: 0.5px;
        }

        .status-approved {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-rejected {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .status-approved-with-warning {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--warning);
            border: 1px solid rgba(255, 193, 7, 0.5);
        }

        /* Estilos para tarjetas de resumen */
        .summary-card {
            border-left: 4px solid var(--primary-light);
            transition: all 0.3s ease;
            background-color: white;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Efecto hover para tarjetas de resumen */
        .summary-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }

        .summary-card .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .summary-card .card-title {
            color: var(--gray);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-card .card-text {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--dark);
        }

        .summary-card .card-unit {
            color: var(--gray);
            font-size: 0.85rem;
        }

        /* Estilos para las pestañas de navegación */
        .nav-tabs {
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        }

        .nav-tabs .nav-link {
            border: none;
            color: var(--gray);
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            border-radius: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary);
            background-color: rgba(26, 75, 140, 0.05);
        }

        .nav-tabs .nav-link.active {
            font-weight: 600;
            color: var(--primary);
            background-color: transparent;
            border-bottom: 3px solid var(--primary);
        }

        /* Estilos para botones primarios */
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
            font-weight: 500;
            letter-spacing: 0.5px;
            padding: 0.5rem 1.25rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 75, 140, 0.3);
        }

        /* Estilos para botones de exportación */
        .btn-export {
            background-color: var(--secondary);
            border-color: var(--secondary);
            color: white;
            font-weight: 500;
            letter-spacing: 0.5px;
            padding: 0.5rem 1.25rem;
            transition: all 0.3s ease;
        }

        .btn-export:hover {
            background-color: #21867a;
            border-color: #21867a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(42, 157, 143, 0.3);
        }

        /* Estilos para controles de formulario */
        .form-control,
        .form-select {
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 0.25rem rgba(42, 117, 216, 0.15);
        }

        .input-group-text {
            background-color: #f8f9fa;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        /* Estilos para el contenedor del logo/encabezado principal */
        .logo-container {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 2.5rem;
            border-radius: 0.75rem;
            color: white;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .logo-container::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
            transform: rotate(30deg);
        }

        .logo-container h1 {
            font-weight: 700;
            margin-bottom: 0.75rem;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .logo-container h1 i {
            font-size: 2.5rem;
        }

        .logo-container .lead {
            font-size: 1.25rem;
            opacity: 0.9;
            margin-bottom: 0;
            position: relative;
        }

        /* Estilos para el contenedor de gráficos */
        .chart-container {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            /* Asegura scroll horizontal si el gráfico es muy ancho */
            overflow-x: auto;
        }

        /* Estilos para tablas responsivas */
        .table-responsive {
            border-radius: 0.75rem;
            overflow: hidden;
            /* Asegura scroll horizontal y vertical para la tabla de resultados */
            overflow-x: auto;
            overflow-y: auto;
            max-height: 500px;
            /* Altura máxima para scroll vertical */
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background-color: #f8f9fa;
            border-bottom-width: 2px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            color: var(--gray);
            padding: 1rem;
            /* Evita que los encabezados se corten */
            white-space: nowrap;
        }

        .table tbody td {
            padding: 0.75rem 1rem;
            vertical-align: middle;
            border-top: 1px solid rgba(0, 0, 0, 0.03);
            /* Evita que el contenido de las celdas se corte */
            white-space: nowrap;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        /* Estilos para la alerta flotante */
        .alert-fixed {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: none;
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }

        .alert-fixed.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Estilos para modales */
        .modal-content {
            border-radius: 0.75rem;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            border-bottom: none;
            padding: 1.5rem 1.5rem 0.5rem;
        }

        .modal-body {
            padding: 1rem 1.5rem;
        }

        .modal-footer {
            border-top: none;
            padding: 1rem 1.5rem 1.5rem;
        }

        /* Contenedor de resultados de tabla */
        .results-container {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }

        .results-table {
            min-width: 100%;
            margin-bottom: 0;
        }

        .results-table th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }

        /* Contenedor de gráfico de vista previa */
        #previewChartContainer {
            height: 300px;
            width: 100%;
            position: relative;
            margin: 0 auto;
            background-color: #f8f9fa;
            border-radius: 5px;
            overflow: hidden;
        }

        #previewChart {
            width: 100% !important;
            height: 100% !important;
        }

        /* Media queries para responsividad */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.85rem;
            }

            .logo-container {
                padding: 1.5rem;
            }

            .logo-container h1 {
                font-size: 1.75rem;
            }

            .logo-container .lead {
                font-size: 1rem;
            }

            .nav-tabs .nav-link {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            #previewChartContainer {
                height: 250px;
            }
        }

        /* Media query adicional para pantallas muy pequeñas (móviles) */
        @media (max-width: 576px) {
            .card-body {
                padding: 1rem;
            }

            .table-responsive {
                font-size: 0.75rem;
            }

            .nav-tabs .nav-link {
                padding: 0.5rem;
                font-size: 0.8rem;
            }

            .summary-card .card-text {
                font-size: 1.25rem;
            }

            #previewChartContainer {
                height: 200px;
            }

            /* Asegurar que los inputs sean legibles */
            .form-control,
            .form-select {
                font-size: 0.9rem;
                padding: 0.4rem 0.8rem;
            }

            /* Mejorar visualización de botones */
            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <!-- Barra de navegación principal -->
    <nav class="navbar navbar-expand-lg navbar-dark"
        style="background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-fire me-2"></i>TODO GAS SYR S.A.S
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-label="Mostrar menú de navegación" title="Abrir menú">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <!-- Botón para exportar PDF desde la barra de navegación -->
                        <button class="btn btn-sm btn-export me-2" id="exportPdfBtn">
                            <i class="bi bi-file-earmark-pdf me-1"></i> Exportar PDF HD
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <!-- Encabezado principal del sistema -->
        <div class="logo-container text-center mb-4">
            <h1><i class="bi bi-fire"></i> Sistema de Cálculo de Redes de Gas</h1>
            <p class="lead mb-0">Diseño, análisis y documentación de instalaciones de gas</p>
        </div>

        <!-- Pestañas de navegación principal (Cálculos, Cliente, Informe) -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="calculation-tab" data-bs-toggle="tab" data-bs-target="#calculation"
                    type="button" role="tab">
                    <i class="bi bi-calculator"></i> Cálculos Técnicos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="client-tab" data-bs-toggle="tab" data-bs-target="#client" type="button"
                    role="tab">
                    <i class="bi bi-person-badge"></i> Datos del Cliente
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button"
                    role="tab">
                    <i class="bi bi-file-text"></i> Vista Previa Informe
                </button>
            </li>
        </ul>

        <!-- Contenido de las pestañas -->
        <div class="tab-content" id="mainTabsContent">
            <!-- Pestaña de Cálculos -->
            <div class="tab-pane fade show active" id="calculation" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4">
                        <!-- Tarjeta de Configuración del Proyecto -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-gear"></i> Configuración del Proyecto</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="projectName" class="form-label">Nombre del Proyecto</label>
                                    <input type="text" class="form-control" id="projectName"
                                        placeholder="Ej: Instalación Residencial">
                                </div>

                                <div class="mb-3">
                                    <label for="gasType" class="form-label">Tipo de Gas</label>
                                    <select class="form-select" id="gasType">
                                        <option value="GN">Gas Natural (GN)</option>
                                        <option value="GLP">Gas Licuado de Petróleo (GLP)</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="pressureLevel" class="form-label">Nivel de Presión</label>
                                    <select class="form-select" id="pressureLevel">
                                        <option value="low">Baja Presión (17-30 mbar)</option>
                                        <option value="medium">Media Presión (50-5000 mbar)</option>
                                        <option value="high">Alta Presión (5001-10000 mbar)</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="material" class="form-label">Material de Tubería</label>
                                    <select class="form-select" id="material">
                                        <option value="PE">Polietileno (PE AL PE)</option>
                                        <option value="PE_P80">Polietileno P80 Amarilla</option>
                                        <option value="copper">Cobre</option>
                                        <option value="steel">Acero Galvanizado</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="initialPressure" class="form-label">Presión Inicial (Pi)</label>
                                    <div class="input-group">
                                        <input type="number" step="0.1" class="form-control" id="initialPressure">
                                        <span class="input-group-text">mbar</span>
                                    </div>
                                    <small class="text-muted">La presión inicial se establece para el nodo de inicio del primer tramo en la red.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Tarjeta de Formulario para Agregar Tramos -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-node-plus"></i> Agregar Tramo</h5>
                            </div>
                            <div class="card-body">
                                <form id="segmentForm">
                                    <input type="hidden" id="editingSegmentIndex">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <label for="startNode" class="form-label">Desde Nodo</label>
                                            <input type="text" class="form-control" id="startNode" placeholder="Ej: A"
                                                required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="endNode" class="form-label">Hasta Nodo</label>
                                            <input type="text" class="form-control" id="endNode" placeholder="Ej: B"
                                                required>
                                        </div>
                                    </div>

                                    <div class="row g-2 mt-2">
                                        <div class="col-md-6">
                                            <label for="flowRate" class="form-label">Caudal</label>
                                            <div class="input-group">
                                                <input type="number" step="0.01" class="form-control" id="flowRate"
                                                    value="1.00" required>
                                                <span class="input-group-text">m³/h</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="segmentLength" class="form-label">Longitud</label>
                                            <div class="input-group">
                                                <input type="number" step="0.01" class="form-control" id="segmentLength"
                                                    value="10.0" required>
                                                <span class="input-group-text">m</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        <label for="diameter" class="form-label">Diámetro</label>
                                        <div class="input-group">
                                            <input type="number" step="0.1" class="form-control" id="diameter" required>
                                            <span class="input-group-text">mm</span>
                                        </div>
                                        <small class="text-muted">Diámetro recomendado: <span id="recommendedDiameter"
                                                class="fw-bold">-</span> mm</small>
                                    </div>

                                    <div class="d-grid gap-2 mt-3">
                                        <button type="submit" class="btn btn-primary" id="addSegmentBtn">
                                            <i class="bi bi-plus-circle me-1"></i> Agregar Tramo
                                        </button>
                                        <button type="button" class="btn btn-success" id="calculateBtn">
                                            <i class="bi bi-lightning-charge me-1"></i> Calcular Red
                                        </button>
                                        <button type="button" class="btn btn-danger" id="clearBtn">
                                            <i class="bi bi-trash me-1"></i> Limpiar Todo
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <!-- Tarjeta de Resultados del Análisis (Tabla de Tramos) -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-table"></i> Resultados del Análisis</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table id="resultsTable"
                                        class="table table-hover table-bordered align-middle text-center"
                                        style="font-size: 0.85rem;">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>#</th>
                                                <th>Desde</th>
                                                <th>Hasta</th>
                                                <th>Caudal (m³/h)</th>
                                                <th>Long. (m)</th>
                                                <th>Diám. (mm)</th>
                                                <th>Pi (mbar)</th>
                                                <th><strong>Pérdida</strong> (mbar)</th>
                                                <th>Pf (mbar)</th>
                                                <th>Veloc. (m/s)</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="resultsTableBody">
                                            <!-- Las filas de tramos calculados aparecerán aquí -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Tarjeta de Resumen Técnico del Proyecto -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Resumen Técnico</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <div class="card summary-card h-100">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">Presión Inicial</h6>
                                                <p class="card-text" id="summaryInitialPressure">0.00</p>
                                                <p class="card-unit">mbar</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card summary-card h-100">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">Presión Final</h6>
                                                <p class="card-text" id="summaryFinalPressure">0.00</p>
                                                <p class="card-unit">mbar</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card summary-card h-100">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">Pérdida Total</h6>
                                                <p class="card-text" id="summaryTotalLoss">0.00</p>
                                                <p class="card-unit">mbar</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <div class="card summary-card h-100">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">Velocidad Máx.</h6>
                                                <p class="card-text" id="summaryMaxVelocity">0.00</p>
                                                <p class="card-unit">m/s</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card summary-card h-100">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">Tramos Aprob.</h6>
                                                <p class="card-text" id="summaryApprovedSegments">0</p>
                                                <p class="card-unit">de <span id="summaryTotalSegments">0</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card summary-card h-100">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">Estado General</h6>
                                                <p class="card-text" id="summaryStatus">-</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tarjeta de Gráfico de Presión y Velocidad -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Perfil de Presión y Velocidad</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container"
                                    style="min-height: 400px; width: 100%; position: relative;">
                                    <canvas id="pressureChart"
                                        style="width: 100%; height: 100%; display: block;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña de Datos del Cliente -->
            <div class="tab-pane fade" id="client" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-person"></i> Información del Cliente</h5>
                            </div>
                            <div class="card-body">
                                <form id="clientForm">
                                    <div class="mb-3">
                                        <label for="clientName" class="form-label">Nombre Completo</label>
                                        <input type="text" class="form-control" id="clientName">
                                    </div>

                                    <div class="mb-3">
                                        <label for="clientId" class="form-label">Identificación</label>
                                        <input type="text" class="form-control" id="clientId">
                                    </div>

                                    <div class="mb-3">
                                        <label for="clientPhone" class="form-label">Teléfono</label>
                                        <input type="tel" class="form-control" id="clientPhone">
                                    </div>

                                    <div class="mb-3">
                                        <label for="clientEmail" class="form-label">Correo Electrónico</label>
                                        <input type="email" class="form-control" id="clientEmail">
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-house"></i> Información de la Instalación</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="clientAddress" class="form-label">Dirección</label>
                                    <input type="text" class="form-control" id="clientAddress">
                                </div>

                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="clientCity" class="form-label">Ciudad/Municipio</label>
                                            <input type="text" class="form-control" id="clientCity">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="clientDepartment" class="form-label">Departamento</label>
                                            <input type="text" class="form-control" id="clientDepartment">
                                        </div>
                                        </div>
                                </div>

                                <div class="mb-3">
                                    <label for="projectType" class="form-label">Tipo de Proyecto</label>
                                    <select class="form-select" id="projectType">
                                        <option value="Residencial">Residencial</option>
                                        <option value="Comercial">Comercial</option>
                                        <option value="Industrial">Industrial</option>
                                        <option value="Institucional">Institucional</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="projectNotes" class="form-label">Notas Adicionales</label>
                                    <textarea class="form-control" id="projectNotes" rows="3"></textarea>
                                </div>

                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" id="saveClientBtn">
                                        <i class="bi bi-save me-1"></i> Guardar Información
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña de Vista Previa del Informe PDF -->
            <div class="tab-pane fade" id="report" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-file-earmark-pdf"></i> Vista Previa del Informe</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i> Esta vista previa muestra cómo se verán los datos en
                            el informe PDF. Para obtener la versión completa en alta calidad, utilice el botón "Exportar
                            PDF HD".
                        </div>

                        <!-- Contenedor del contenido del PDF para html2canvas -->
                        <div id="pdfPreview" class="border p-4 bg-white">
                            <div class="text-center mb-4">
                                <h2 style="color: #1a4b8c;">INFORME TÉCNICO DE RED DE GAS</h2>
                                <p class="text-muted">Proyecto: <span id="previewProjectName">Sin nombre</span> | Fecha:
                                    <span id="previewDate"></span>
                                </p>
                                <hr style="border-top: 2px solid #1a4b8c;">
                            </div>

                            <h4 style="color: #1a4b8c; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px;">1.
                                INFORMACIÓN DEL CLIENTE</h4>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <p><strong>Nombre:</strong> <span id="previewClientName">-</span></p>
                                    <p><strong>Identificación:</strong> <span id="previewClientId">-</span></p>
                                    <p><strong>Dirección:</strong> <span id="previewClientAddress">-</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Teléfono:</strong> <span id="previewClientPhone">-</span></p>
                                    <p><strong>Ciudad:</strong> <span id="previewClientCity">-</span></p>
                                    <p><strong>Proyecto:</strong> <span id="previewProjectType">-</span></p>
                                </div>
                            </div>

                            <h4 style="color: #1a4b8c; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px;">2.
                                CONFIGURACIÓN TÉCNICA</h4>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <p><strong>Tipo de Gas:</strong> <span id="previewGasType">-</span></p>
                                    <p><strong>Nivel de Presión:</strong> <span id="previewPressureLevel">-</span></p>
                                    <p><strong>Material Tubería:</strong> <span id="previewMaterial">-</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Presión Inicial:</strong> <span id="previewInitialPressure">-</span> mbar
                                    </p>
                                    <p><strong>Fórmula Aplicada:</strong> <span id="previewFormula">-</span></p>
                                    <p><strong>Tramos Calculados:</strong> <span id="previewSegmentCount">0</span></p>
                                </div>
                            </div>

                            <h4 style="color: #1a4b8c; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px;">3.
                                RESUMEN TÉCNICO</h4>
                            <div class="row mb-4">
                                <div class="col-md-4 text-center p-3"
                                    style="background-color: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                                    <h5>Presión Inicial</h5>
                                    <h3 id="previewSummaryInitialPressure">0.00</h3>
                                    <p class="text-muted">mbar</p>
                                </div>
                                <div class="col-md-4 text-center p-3"
                                    style="background-color: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                                    <h5>Presión Final</h5>
                                    <h3 id="previewSummaryFinalPressure">0.00</h3>
                                    <p class="text-muted">mbar</p>
                                </div>
                                <div class="col-md-4 text-center p-3"
                                    style="background-color: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                                    <h5>Pérdida Total</h5>
                                    <h3 id="previewSummaryTotalLoss">0.00</h3>
                                    <p class="card-unit">mbar</p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 text-center p-3"
                                    style="background-color: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                                    <h5>Velocidad Máxima</h5>
                                    <h3 id="previewSummaryMaxVelocity">0.00</h3>
                                    <p class="card-unit">m/s</p>
                                </div>
                                <div class="col-md-4 text-center p-3"
                                    style="background-color: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                                    <h5>Tramos Aprobados</h5>
                                    <h3 id="previewSummaryApprovedSegments">0</h3>
                                    <p class="card-unit">de <span id="previewSummaryTotalSegments">0</span></p>
                                </div>
                                <div class="col-md-4 text-center p-3"
                                    style="background-color: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                                    <h5>Estado General</h5>
                                    <h4 id="previewSummaryStatus">-</h4>
                                </div>
                            </div>

                            <h4
                                style="color: #1a4b8c; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; margin-top: 20px;">
                                4. DETALLE DE TRAMOS</h4>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered" style="font-size: 0.85rem;">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Desde</th>
                                            <th>Hasta</th>
                                            <th>Caudal (m³/h)</th>
                                            <th>Long. (m)</th>
                                            <th>Diám. (mm)</th>
                                            <th>Pi (mbar)</th>
                                            <th>Pf (mbar)</th>
                                            <th>Veloc. (m/s)</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody id="previewResultsTable">
                                        <!-- Datos de vista previa se insertarán aquí -->
                                    </tbody>
                                </table>
                            </div>

                            <h4
                                style="color: #1a4b8c; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; margin-top: 20px;">
                                5. GRÁFICO DE PRESIÓN Y VELOCIDAD</h4>
                            <div id="previewChartContainer">
                                <canvas id="previewChart"></canvas>
                            </div>

                            <h4
                                style="color: #1a4b8c; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; margin-top: 20px;">
                                6. OBSERVACIONES Y FIRMA</h4>
                            <div class="mb-4">
                                <p><strong>Observaciones:</strong></p>
                                <p id="previewProjectNotes">No se registraron observaciones adicionales.</p>
                            </div>
                            <div style="margin-top: 50px;">
                                <div style="width: 200px; border-top: 1px solid #000; margin-bottom: 5px;"></div>
                                <p>Firma del Responsable Técnico</p>
                            </div>

                            <div class="text-center mt-5" style="font-size: 0.8rem; color: #6c757d;">
                                <p>Documento generado por Todo Gas - Sistema de Cálculo de Redes de Gas
                                </p>
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <!-- Botón para exportar PDF desde la vista previa -->
                            <button class="btn btn-export" id="exportFromPreviewBtn">
                                <i class="bi bi-file-earmark-pdf me-1"></i> Exportar a PDF HD
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación (reemplaza alert/confirm nativos) -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>Confirmar
                        Acción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    ¿Está seguro de realizar esta acción?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmModalBtn">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerta flotante para notificaciones (reemplaza alert nativo) -->
    <div class="alert-fixed" id="globalAlert">
        <i class="bi" id="alertIcon"></i>
        <span id="alertMessage"></span>
    </div>

    <!-- Scripts de Bootstrap y lógica de la aplicación -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Objeto de configuración global para parámetros de gas, materiales y presión
        const CONFIG = {
            gases: {
                GN: {
                    name: "Gas Natural (GN)",
                    density: 0.717, // kg/m³ a 15°C
                    specificGravity: 0.6, // Gravedad específica relativa al aire
                    viscosity: 0.000011, // Pa·s
                    maxVelocity: 25 // Límite de velocidad unificado para flexibilidad (m/s)
                },
                GLP: {
                    name: "Gas Licuado de Petróleo (GLP)",
                    density: 2.01, // kg/m³ a 15°C
                    specificGravity: 1.5,
                    viscosity: 0.000008,
                    maxVelocity: 25 // Límite de velocidad unificado para flexibilidad (m/s)
                }
            },
            materials: {
                PE: {
                    name: "Polietileno (PE AL PE)",
                    diameters: [12, 16, 20, 25, 32, 40, 50, 63, 90], // Diámetros estándar en mm
                    roughness: 0.0015, // mm
                    factor: 1.2, // Factor para longitud equivalente
                    color: "#3498db"
                },
                PE_P80: {
                    name: "Polietileno P80 Amarilla",
                    diameters: [12, 16, 20, 25, 32, 40, 50, 63, 90, 110, 125, 160, 180, 200, 225, 250, 280, 315], // Diámetros estándar en mm
                    roughness: 0.0015, // mm
                    factor: 1.2, // Factor para longitud equivalente
                    color: "#f1c40f" // Color representativo (amarillo)
                },
                copper: {
                    name: "Cobre",
                    diameters: [12, 16, 20, 22, 28, 35, 42, 54],
                    roughness: 0.001,
                    factor: 1.15,
                    color: "#e67e22"
                },
                steel: {
                    name: "Acero Galvanizado",
                    diameters: [12.7, 19.1, 25.4, 31.8, 38.1, 50.8, 63.5, 76.2, 101.6],
                    roughness: 0.15,
                    factor: 1.25,
                    color: "#95a5a6"
                }
            },
            pressures: {
                low: {
                    name: "Baja Presión",
                    min: 17, // mbar (para validación de Pi inicial)
                    max: 30, // mbar (para validación de Pi inicial)
                    default: 23, // mbar
                    maxLossFixed: 5.0, // mbar (pérdida máxima fija para baja presión)
                    minFinalPressure: 20, // mbar (presión final mínima para aprobación)
                    maxVelocityLow: 25, // Velocidad máxima específica para baja presión (m/s)
                    formula: "Renouard Simplificada"
                },
                medium: {
                    name: "Media Presión",
                    min: 50,
                    max: 5000,
                    default: 350,
                    maxLossPercent: 15, // % de pérdida máxima para media presión
                    minFinalPressure: 50, // mbar (presión final mínima para aprobación)
                    maxVelocityMedium: 30, // Velocidad máxima específica para media presión (m/s)
                    formula: "Panhandle A"
                },
                high: {
                    name: "Alta Presión",
                    min: 5001,
                    max: 10000,
                    default: 6000,
                    maxLossPercent: 20, // % de pérdida máxima para alta presión
                    minFinalPressure: 5001, // mbar (presión final mínima para aprobación)
                    maxVelocityHigh: 40, // Velocidad máxima específica para alta presión (m/s)
                    formula: "Panhandle B"
                }
            }
        };

        // Variables globales para el estado de la aplicación
        const { jsPDF } = window.jspdf; // Desestructuración para acceder a jsPDF
        let segments = []; // Array para almacenar los datos de cada tramo
        let nodePressures = new Map(); // Mapa para almacenar las presiones calculadas en cada nodo
        let pressureChart = null; // Instancia del gráfico principal
        let previewChart = null; // Instancia del gráfico de vista previa del PDF
        let currentClient = { // Objeto para almacenar la información del cliente
            name: "", id: "", phone: "", email: "", address: "", city: "", department: "",
            projectType: "Residencial", projectNotes: ""
        };
        let currentProject = { // Objeto para almacenar la configuración del proyecto
            name: "Nuevo Proyecto", gasType: "GN", pressureLevel: "low", material: "PE",
            initialPressure: CONFIG.pressures.low.default
        };
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal')); // Instancia del modal de confirmación

        // Límite máximo de tramos para evitar sobrecarga
        const MAX_SEGMENTS = 100; // Aumentado para permitir más tramos

        // --- Inicialización de la aplicación ---
        document.addEventListener('DOMContentLoaded', function () {
            initializeEventListeners(); // Configura todos los listeners de eventos
            initializeValues(); // Establece valores iniciales en los campos
            loadSavedData(); // Carga datos guardados del localStorage
        });

        // Configura los listeners de eventos para los elementos de la UI
        function initializeEventListeners() {
            // Eventos de configuración del proyecto
            document.getElementById('pressureLevel').addEventListener('change', updateInitialPressure);
            document.getElementById('gasType').addEventListener('change', updateRecommendedDiameter);
            document.getElementById('material').addEventListener('change', updateRecommendedDiameter);
            document.getElementById('flowRate').addEventListener('input', updateRecommendedDiameter);
            document.getElementById('projectName').addEventListener('input', updateProjectName);
            // Listener para guardar la presión inicial si se cambia manualmente
            document.getElementById('initialPressure').addEventListener('input', function () {
                const value = parseFloat(this.value);
                if (!isNaN(value)) {
                    currentProject.initialPressure = value;
                }
            });

            // Eventos de formularios y botones de acción
            document.getElementById('segmentForm').addEventListener('submit', handleSegmentSubmit); // Cambiado a handleSegmentSubmit
            document.getElementById('calculateBtn').addEventListener('click', calculateNetwork);
            document.getElementById('clearBtn').addEventListener('click', confirmClearAll);
            document.getElementById('saveClientBtn').addEventListener('click', saveClientData);
            document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
            document.getElementById('exportFromPreviewBtn').addEventListener('click', exportToPDF);

            // Evento para actualizar la vista previa del informe al cambiar de pestaña
            document.getElementById('report-tab').addEventListener('click', updateReportPreview);
        }

        // Establece los valores iniciales en los campos de configuración
        function initializeValues() {
            updateInitialPressure(); // Actualiza la presión inicial por defecto
            updateRecommendedDiameter(); // Actualiza el diámetro recomendado
            updatePreviewDate(); // Establece la fecha actual en la vista previa del informe
        }

        // --- Funciones de configuración del proyecto ---
        /**
         * Actualiza el valor de la presión inicial en el campo de entrada
         * y en el objeto de proyecto según el nivel de presión seleccionado.
         */
        function updateInitialPressure() {
            const pressureLevel = document.getElementById('pressureLevel').value;
            const defaultPressure = CONFIG.pressures[pressureLevel].default;
            document.getElementById('initialPressure').value = defaultPressure;
            currentProject.pressureLevel = pressureLevel;
            currentProject.initialPressure = defaultPressure; // Asegura que el valor en el objeto coincida con el campo
        }

        /**
         * Calcula y muestra el diámetro recomendado basado en caudal, tipo de gas y material.
         * La recomendación se basa en la velocidad máxima permitida para el tipo de gas.
         */
        function updateRecommendedDiameter() {
            const flowRate = parseFloat(document.getElementById('flowRate').value) || 1.0;
            const gasType = document.getElementById('gasType').value;
            const pressureLevel = document.getElementById('pressureLevel').value; // Obtener nivel de presión
            const material = document.getElementById('material').value;

            currentProject.gasType = gasType;
            currentProject.material = material;

            // Obtener la velocidad máxima específica para el nivel de presión actual
            let maxVelocity;
            if (pressureLevel === 'low') {
                maxVelocity = CONFIG.pressures.low.maxVelocityLow;
            } else if (pressureLevel === 'medium') {
                maxVelocity = CONFIG.pressures.medium.maxVelocityMedium;
            } else if (pressureLevel === 'high') {
                maxVelocity = CONFIG.pressures.high.maxVelocityHigh;
            } else {
                maxVelocity = CONFIG.gases[gasType].maxVelocity; // Fallback si no hay límite específico por presión
            }


            // Calcula el diámetro mínimo requerido en metros, luego convierte a mm
            // Fórmula: Área = Caudal / Velocidad. Área = pi * (D/2)^2 => D = sqrt(4 * Area / pi)
            // Caudal (m³/h) debe convertirse a m³/s para la velocidad en m/s
            const Q_mps = flowRate / 3600; // Caudal en m³/s
            const D_meters = Math.sqrt((4 * Q_mps) / (Math.PI * maxVelocity));
            const D_mm = D_meters * 1000;

            // El diámetro recomendado debe ser al menos 12mm (mínimo especificado por el usuario)
            const recommended = Math.max(12, Math.ceil(D_mm));

            document.getElementById('recommendedDiameter').textContent = recommended.toFixed(1);
            // Si el campo de diámetro está vacío o el valor actual es menor que el recomendado, se rellena
            if (document.getElementById('diameter').value === "" || parseFloat(document.getElementById('diameter').value) < recommended) {
                document.getElementById('diameter').value = recommended.toFixed(1);
            }
        }

        /**
         * Actualiza el nombre del proyecto en el objeto de configuración global.
         */
        function updateProjectName() {
            currentProject.name = document.getElementById('projectName').value.trim() || "Nuevo Proyecto";
        }

        /**
         * Establece la fecha actual en el formato de la vista previa del informe.
         */
        function updatePreviewDate() {
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const previewDateEl = document.getElementById('previewDate');
            if (previewDateEl) previewDateEl.textContent = today.toLocaleDateString('es-CO', options);
        }

        // --- Funciones de gestión de datos (localStorage) ---
        /**
         * Carga los datos guardados del localStorage al iniciar la aplicación.
         */
        function loadSavedData() {
            const savedProject = localStorage.getItem('gaspro_project');
            const savedClient = localStorage.getItem('gaspro_client');
            const savedSegments = localStorage.getItem('gaspro_segments');

            if (savedProject) {
                currentProject = JSON.parse(savedProject);
                document.getElementById('projectName').value = currentProject.name;
                document.getElementById('gasType').value = currentProject.gasType;
                document.getElementById('pressureLevel').value = currentProject.pressureLevel;
                document.getElementById('material').value = currentProject.material;
                document.getElementById('initialPressure').value = currentProject.initialPressure;
            }

            if (savedClient) {
                currentClient = JSON.parse(savedClient);
                document.getElementById('clientName').value = currentClient.name;
                document.getElementById('clientId').value = currentClient.id;
                document.getElementById('clientPhone').value = currentClient.phone;
                document.getElementById('clientEmail').value = currentClient.email;
                document.getElementById('clientAddress').value = currentClient.address;
                document.getElementById('clientCity').value = currentClient.city;
                document.getElementById('clientDepartment').value = currentClient.department;
                document.getElementById('projectType').value = currentClient.projectType;
                document.getElementById('projectNotes').value = currentClient.projectNotes;
            }

            if (savedSegments) {
                segments = JSON.parse(savedSegments);
                calculateNetwork(); // Recalcula la red con los datos cargados
            }
        }

        /**
         * Guarda el estado actual del proyecto, cliente y segmentos en localStorage.
         */
        function saveDataToLocalStorage() {
            localStorage.setItem('gaspro_project', JSON.stringify(currentProject));
            localStorage.setItem('gaspro_client', JSON.stringify(currentClient));
            localStorage.setItem('gaspro_segments', JSON.stringify(segments));
        }

        /**
         * Guarda la información del cliente y del proyecto desde los campos del formulario.
         */
        function saveClientData() {
            currentClient = {
                name: document.getElementById('clientName').value.trim(),
                id: document.getElementById('clientId').value.trim(),
                phone: document.getElementById('clientPhone').value.trim(),
                email: document.getElementById('clientEmail').value.trim(),
                address: document.getElementById('clientAddress').value.trim(),
                city: document.getElementById('clientCity').value.trim(),
                department: document.getElementById('clientDepartment').value.trim(),
                projectType: document.getElementById('projectType').value,
                projectNotes: document.getElementById('projectNotes').value.trim()
            };

            currentProject.name = document.getElementById('projectName').value.trim() || "Nuevo Proyecto";

            saveDataToLocalStorage(); // Guarda los datos actualizados
            showAlert("success", "Datos del cliente y proyecto guardados correctamente");
        }

        // --- Funciones de gestión de tramos ---
        /**
         * Maneja el envío del formulario, decidiendo si añadir un nuevo tramo o actualizar uno existente.
         * @param {Event} e - El evento de envío del formulario.
         */
        function handleSegmentSubmit(e) {
            e.preventDefault(); // Previene el envío del formulario

            const editingIndex = document.getElementById('editingSegmentIndex').value;
            if (editingIndex !== '') {
                updateSegment(parseInt(editingIndex));
            } else {
                addSegment();
            }
        }

        /**
         * Añade un nuevo tramo a la lista de segmentos después de validar las entradas.
         */
        function addSegment() {
            if (segments.length >= MAX_SEGMENTS) {
                showAlert("warning", `Límite alcanzado: No se pueden agregar más de ${MAX_SEGMENTS} tramos`);
                return;
            }

            const startNode = document.getElementById('startNode').value.trim().toUpperCase();
            const endNode = document.getElementById('endNode').value.trim().toUpperCase();
            const flowRate = parseFloat(document.getElementById('flowRate').value);
            const length = parseFloat(document.getElementById('segmentLength').value);
            const diameter = parseFloat(document.getElementById('diameter').value);

            // Validación de entradas
            const errors = validateSegmentInputs(startNode, endNode, flowRate, length, diameter);
            if (errors.length > 0) {
                showAlert("danger", errors.join("<br>"));
                return;
            }

            // Generar un ID único para el nuevo segmento. Se usará para identificarlo durante la edición/eliminación
            // y para mantener su referencia a través de las reordenaciones.
            const newSegmentId = segments.length > 0 ? Math.max(...segments.map(s => s.originalId || s.id)) + 1 : 1;

            const newSegment = {
                originalId: newSegmentId, // Guarda un ID original para referencia
                id: newSegmentId, // ID que se mostrará en la tabla, se reasignará después del sort
                startNode,
                endNode,
                flowRate,
                length,
                diameter,
                initialPressure: 0, // Se recalculará en calculateNetwork
                finalPressure: 0,
                pressureLoss: 0,
                velocity: 0,
                material: currentProject.material,
                status: "pending",
                warnings: []
            };
            segments.push(newSegment);

            calculateNetwork(); // Recalcula toda la red
            resetSegmentForm(flowRate); // Resetea el formulario para el siguiente tramo
            saveDataToLocalStorage(); // Guarda los datos
            showAlert("success", `Tramo ${startNode}-${endNode} agregado correctamente`);
        }

        /**
         * Actualiza un tramo existente en la lista de segmentos.
         * @param {number} index - El índice del tramo a actualizar.
         */
        function updateSegment(index) {
            const segmentToUpdate = segments[index];

            const startNode = document.getElementById('startNode').value.trim().toUpperCase();
            const endNode = document.getElementById('endNode').value.trim().toUpperCase();
            const flowRate = parseFloat(document.getElementById('flowRate').value);
            const length = parseFloat(document.getElementById('segmentLength').value);
            const diameter = parseFloat(document.getElementById('diameter').value);

            // Validación de entradas
            const errors = validateSegmentInputs(startNode, endNode, flowRate, length, diameter);
            if (errors.length > 0) {
                showAlert("danger", errors.join("<br>"));
                return;
            }

            // Actualiza las propiedades del segmento existente
            segmentToUpdate.startNode = startNode;
            segmentToUpdate.endNode = endNode;
            segmentToUpdate.flowRate = flowRate;
            segmentToUpdate.length = length;
            segmentToUpdate.diameter = diameter;
            segmentToUpdate.material = currentProject.material; // Asegura que el material se actualice si se cambió en la configuración

            calculateNetwork(); // Recalcula toda la red con el tramo actualizado
            resetSegmentForm(flowRate); // Resetea el formulario y lo pone en modo "agregar"
            saveDataToLocalStorage(); // Guarda los datos
            showAlert("success", `Tramo ${startNode}-${endNode} actualizado correctamente`);
        }

        /**
         * Valida las entradas del formulario de tramos.
         * @param {string} startNode - Nodo de inicio.
         * @param {string} endNode - Nodo final.
         * @param {number} flowRate - Caudal.
         * @param {number} length - Longitud.
         * @param {number} diameter - Diámetro.
         * @returns {string[]} Un array de mensajes de error.
         */
        function validateSegmentInputs(startNode, endNode, flowRate, length, diameter) {
            const errors = [];
            if (!startNode || !endNode) errors.push("Debe ingresar nodos de inicio y fin.");
            if (startNode === endNode) errors.push("Los nodos de inicio y fin no pueden ser iguales.");
            if (isNaN(flowRate) || flowRate <= 0) errors.push("Caudal debe ser un número positivo.");
            if (isNaN(length) || length <= 0 || length > 10000) errors.push("Longitud debe estar entre 0.01 y 10000 metros."); // Updated min length
            if (isNaN(diameter) || diameter <= 0) {
                errors.push("Diámetro debe ser un número positivo.");
            } else if (diameter < 12) { // Diámetro mínimo permitido de 12 mm
                errors.push("El diámetro mínimo permitido es de 12 mm.");
            }
            return errors;
        }

        /**
         * Resetea el formulario de tramos después de añadir o actualizar uno, manteniendo el nodo final como inicial
         * para facilitar la conexión secuencial y restableciendo el botón a "Agregar Tramo".
         * @param {number} flowRate - El caudal del tramo anterior para pre-rellenar.
         */
        function resetSegmentForm(flowRate) {
            document.getElementById('startNode').value = document.getElementById('endNode').value;
            document.getElementById('endNode').value = "";
            document.getElementById('flowRate').value = flowRate.toFixed(2);
            document.getElementById('segmentLength').value = "10.0";
            document.getElementById('diameter').value = ""; // Borra el diámetro para que se recalcule el recomendado
            updateRecommendedDiameter(); // Actualiza el diámetro recomendado

            // Restablecer el modo de edición
            document.getElementById('editingSegmentIndex').value = '';
            const addSegmentBtn = document.getElementById('addSegmentBtn');
            addSegmentBtn.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Agregar Tramo';
            addSegmentBtn.classList.remove('btn-warning'); // Asegura que vuelva al color original si estaba en warning
            addSegmentBtn.classList.add('btn-primary');

            document.getElementById('endNode').focus(); // Pone el foco en el siguiente nodo final
        }

        /**
         * Edita un tramo existente, rellenando el formulario y configurando el modo de edición.
         * @param {number} index - El índice del tramo a editar.
         */
        function editSegment(index) {
            const segment = segments[index];

            // Rellena el formulario con los datos del tramo a editar
            document.getElementById('startNode').value = segment.startNode;
            document.getElementById('endNode').value = segment.endNode;
            document.getElementById('flowRate').value = segment.flowRate;
            document.getElementById('segmentLength').value = segment.length;
            document.getElementById('diameter').value = segment.diameter;
            
            // Establece el índice del segmento que se está editando en un campo oculto
            document.getElementById('editingSegmentIndex').value = index;

            // Cambia el texto y el estilo del botón para indicar que se está editando
            const addSegmentBtn = document.getElementById('addSegmentBtn');
            addSegmentBtn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i> Actualizar Tramo';
            addSegmentBtn.classList.remove('btn-primary');
            addSegmentBtn.classList.add('btn-warning');

            showAlert("info", `Editando tramo ${segment.startNode}-${segment.endNode}. Modifique los campos y haga clic en "Actualizar Tramo".`);
            document.getElementById('startNode').focus();
        }

        /**
         * Confirma y elimina un tramo de la lista.
         * @param {number} index - El índice del tramo a eliminar.
         */
        function confirmDeleteSegment(index) {
            showConfirm("¿Está seguro de eliminar este tramo?", () => {
                segments.splice(index, 1); // Elimina el tramo
                // No es necesario reasignar IDs aquí, topologicalSort lo hará en calculateNetwork
                calculateNetwork(); // Recalcula la red
                showAlert("success", "Tramo eliminado correctamente.");
            });
        }

        /**
         * Confirma y limpia todos los datos del sistema (tramos, cliente, proyecto).
         */
        function confirmClearAll() {
            showConfirm("¿Está seguro de limpiar todos los datos? Esto eliminará todos los tramos y la configuración.", () => {
                segments = []; // Vacía el array de segmentos
                nodePressures.clear(); // Limpia el mapa de presiones de nodos
                currentClient = { // Resetea la información del cliente
                    name: "", id: "", phone: "", email: "", address: "", city: "", department: "",
                    projectType: "Residencial", projectNotes: ""
                };
                currentProject = { // Resetea la configuración del proyecto
                    name: "Nuevo Proyecto", gasType: "GN", pressureLevel: "low", material: "PE",
                    initialPressure: CONFIG.pressures.low.default
                };
                // Resetea los campos de la UI
                document.getElementById('projectName').value = "";
                document.getElementById('clientName').value = "";
                document.getElementById('clientId').value = "";
                document.getElementById('clientPhone').value = "";
                document.getElementById('clientEmail').value = "";
                document.getElementById('clientAddress').value = "";
                document.getElementById('clientCity').value = "";
                document.getElementById('clientDepartment').value = "";
                document.getElementById('projectType').value = "Residencial";
                document.getElementById('projectNotes').value = "";

                updateInitialPressure(); // Restablece la presión inicial por defecto
                updateRecommendedDiameter(); // Restablece el diámetro recomendado
                calculateNetwork(); // Recalcula la red (vacía)
                saveDataToLocalStorage(); // Guarda el estado vacío
                showAlert("success", "Todos los datos han sido limpiados.");
            });
        }

        // --- Lógica de cálculo de la red ---

        /**
         * Realiza una ordenación topológica de los segmentos utilizando el algoritmo de Kahn.
         * Esto asegura que los segmentos se procesen en un orden de flujo (desde la fuente hacia los sumideros),
         * lo cual es crucial para la propagación correcta de la presión.
         * Detecta ciclos en la red.
         *
         * @param {Array<Object>} segmentsArray - El array de objetos de segmentos.
         * @returns {Array<Object>} Un nuevo array de segmentos ordenados topológicamente.
         * @throws {Error} Si la red contiene ciclos.
         */
        function topologicalSort(segmentsArray) {
            const sortedSegments = [];
            const inDegree = new Map(); // Mapa: nodo -> contador de segmentos entrantes
            const adjList = new Map(); // Lista de adyacencia: startNode -> [segmentos que inician desde este nodo]
            const allNodes = new Set(); // Conjunto de todos los nodos únicos en la red

            // 1. Inicializar grados de entrada (in-degrees) y lista de adyacencia
            for (const segment of segmentsArray) {
                allNodes.add(segment.startNode);
                allNodes.add(segment.endNode);

                if (!adjList.has(segment.startNode)) {
                    adjList.set(segment.startNode, []);
                }
                adjList.get(segment.startNode).push(segment);

                // Asegurar que todos los nodos estén en el mapa inDegree con 0 inicial
                if (!inDegree.has(segment.startNode)) inDegree.set(segment.startNode, 0);
                if (!inDegree.has(segment.endNode)) inDegree.set(segment.endNode, 0);

                // Incrementar el grado de entrada para el nodo final del segmento
                inDegree.set(segment.endNode, inDegree.get(segment.endNode) + 1);
            }

            // 2. Encontrar nodos iniciales (aquellos con grado de entrada 0)
            const queue = [];
            for (const node of allNodes) {
                if (inDegree.get(node) === 0) {
                    queue.push(node);
                }
            }

            // Si no hay nodos con grado de entrada 0 y hay segmentos, significa un ciclo o red aislada
            if (queue.length === 0 && segmentsArray.length > 0) {
                throw new Error("La red contiene un ciclo o segmentos completamente desconectados sin un punto de inicio claro. Verifique la topología.");
            }

            let head = 0;
            while (head < queue.length) {
                const u = queue[head++]; // Desencolar el nodo actual

                // Obtener todos los segmentos que comienzan desde este nodo 'u'
                const segmentsFromU = adjList.get(u) || [];
                // Ordenar estos segmentos por su nodo final para una salida consistente
                segmentsFromU.sort((a, b) => a.endNode.localeCompare(b.endNode));

                for (const segment of segmentsFromU) {
                    sortedSegments.push(segment); // Añadir el segmento a la lista ordenada

                    // Decrementar el grado de entrada para el nodo final del segmento
                    inDegree.set(segment.endNode, inDegree.get(segment.endNode) - 1);

                    // Si el grado de entrada del nodo final se convierte en 0, añadirlo a la cola
                    if (inDegree.get(segment.endNode) === 0) {
                        queue.push(segment.endNode);
                    }
                }
            }

            // 3. Verificar si se detectó un ciclo
            if (sortedSegments.length !== segmentsArray.length) {
                throw new Error("La red contiene un ciclo. No se puede calcular la presión. Verifique la conexión de nodos.");
            }

            // 4. Reasignar IDs para reflejar el nuevo orden de visualización en la tabla
            sortedSegments.forEach((seg, i) => seg.id = i + 1);

            return sortedSegments;
        }


        /**
         * Calcula toda la red de gas, actualizando presiones y estados de los tramos.
         * Esta es la función principal de cálculo.
         */
        function calculateNetwork() {
            try {
                if (segments.length === 0) {
                    renderTable();
                    updateSummary();
                    updateChart();
                    saveDataToLocalStorage();
                    return;
                }

                const gasConfig = CONFIG.gases[currentProject.gasType];
                const pressureConfig = CONFIG.pressures[currentProject.pressureLevel];
                const materialConfig = CONFIG.materials[currentProject.material];

                nodePressures.clear(); // Limpia las presiones de nodos antes de cada cálculo

                // Ordena los segmentos topológicamente para asegurar el flujo de cálculo y el orden de visualización
                // `segments` se actualizará con el array ordenado y con IDs reasignados
                segments = topologicalSort([...segments]); // Pasa una copia para no modificar el array durante el sort

                // Validar presión inicial global del proyecto
                const initialPressureInput = parseFloat(document.getElementById('initialPressure').value);
                if (isNaN(initialPressureInput)) {
                    throw new Error("La presión inicial no es un número válido.");
                }
                if (initialPressureInput < pressureConfig.min || initialPressureInput > pressureConfig.max) {
                    throw new Error(`La presión inicial debe estar entre ${pressureConfig.min} y ${pressureConfig.max} mbar para ${pressureConfig.name}.`);
                }

                // Establecer la presión inicial para el nodo raíz (el inicio del primer segmento ordenado)
                // Esto es crucial para iniciar la propagación de la presión.
                if (segments.length > 0) {
                    nodePressures.set(segments[0].startNode, initialPressureInput);
                }
                
                let initialPressureOverall = initialPressureInput;
                let finalPressureOverall = initialPressureInput; // Se actualizará con la Pf del último tramo en el orden topológico
                let totalLossOverall = 0;
                let maxVelocityOverall = 0;
                let approvedCount = 0;

                // Iterar sobre los segmentos ya ordenados para calcular
                segments.forEach((segment, index) => {
                    let Pi_segment = nodePressures.get(segment.startNode);

                    // Reiniciar advertencias para el segmento actual antes de recalcular
                    segment.warnings = [];

                    if (Pi_segment === undefined) {
                        // Si la presión del nodo de inicio no está disponible (segmento desconectado),
                        // se asignan valores de cero y se marca como rechazado.
                        // Esto permite que el cálculo continúe para otros segmentos.
                        Object.assign(segment, {
                            initialPressure: 0,
                            finalPressure: 0,
                            pressureLoss: 0,
                            velocity: 0,
                            status: "rejected",
                            warnings: ["Nodo de inicio sin presión definida (tramo desconectado)."]
                        });
                        // No se usa showAlert aquí para evitar múltiples alertas si hay muchos tramos desconectados.
                        // El estado en la tabla será suficiente.
                        return; // Salta al resto del cálculo de este segmento, pero el loop continúa
                    }

                    segment.initialPressure = Pi_segment; // Asigna la Pi calculada o inicial
                    const Leq = segment.length * materialConfig.factor; // Longitud equivalente
                    const Dm_meters = segment.diameter / 1000; // Diámetro en metros
                    const Q = segment.flowRate;

                    // Calcular velocidad
                    segment.velocity = (Q * 4) / (Math.PI * Math.pow(Dm_meters, 2) * 3600); // Q en m³/h, Dm_meters en m

                    // Calcular la pérdida de presión
                    let pressureLoss = calculatePressureLoss(
                        currentProject.pressureLevel,
                        Q,
                        Leq,
                        Dm_meters,
                        gasConfig.specificGravity,
                        Pi_segment
                    );

                    // Asegura que la pérdida no sea mayor que la presión inicial del tramo (evita Pf negativa o ilógica)
                    if (pressureLoss > Pi_segment) {
                        pressureLoss = Pi_segment; // La pérdida máxima es la presión inicial
                    }

                    segment.pressureLoss = pressureLoss;
                    segment.finalPressure = Pi_segment - pressureLoss;

                    // --- Lógica de validación de flexibilidad y seguridad ---
                    let maxVelocityThreshold;
                    if (currentProject.pressureLevel === 'low') {
                        maxVelocityThreshold = CONFIG.pressures.low.maxVelocityLow;
                    } else if (currentProject.pressureLevel === 'medium') {
                        maxVelocityThreshold = CONFIG.pressures.medium.maxVelocityMedium;
                    } else if (currentProject.pressureLevel === 'high') {
                        maxVelocityThreshold = CONFIG.pressures.high.maxVelocityHigh;
                    } else {
                        maxVelocityThreshold = gasConfig.maxVelocity; // Fallback
                    }

                    let effectiveMaxLossAllowed;
                    let minFinalPressureThreshold = pressureConfig.minFinalPressure;

                    if (currentProject.pressureLevel === 'low') {
                        effectiveMaxLossAllowed = CONFIG.pressures.low.maxLossFixed; // 5.0 mbar fijo
                    } else {
                        effectiveMaxLossAllowed = Pi_segment * (pressureConfig.maxLossPercent / 100); // % de la Pi
                    }

                    // 1. Detección de ganancia de presión (físicamente imposible en un tramo pasivo)
                    if (segment.finalPressure > Pi_segment + 0.01) { // Pequeña tolerancia para flotantes
                        segment.status = "rejected";
                        segment.warnings.push("Ganancia de presión detectada. Revisar datos o fórmulas.");
                        // showAlert("danger", `Tramo ${segment.startNode}-${segment.endNode}: Ganancia de presión detectada. Revisar datos o fórmulas.`); // Evitar spam de alertas
                    }
                    // 2. Presión final por debajo del mínimo absoluto (rechazo)
                    else if (segment.finalPressure < minFinalPressureThreshold) {
                        segment.status = "rejected";
                        segment.warnings.push(`Presión final (${segment.finalPressure.toFixed(2)} mbar) es menor al mínimo permitido (${minFinalPressureThreshold} mbar).`);
                        // showAlert("danger", `Tramo ${segment.startNode}-${segment.endNode}: Presión final (${segment.finalPressure.toFixed(2)} mbar) es menor al mínimo permitido (${minFinalPressureThreshold} mbar).`);
                    }
                    // 3. Pérdida de presión excesiva (rechazo)
                    else if (segment.pressureLoss > effectiveMaxLossAllowed) {
                        segment.status = "rejected";
                        segment.warnings.push(`Pérdida de presión (${segment.pressureLoss.toFixed(2)} mbar) es excesiva (> ${effectiveMaxLossAllowed.toFixed(2)} mbar).`);
                        // showAlert("danger", `Tramo ${segment.startNode}-${segment.endNode}: Pérdida de presión (${segment.pressureLoss.toFixed(2)} mbar) es excesiva (> ${effectiveMaxLossAllowed.toFixed(2)} mbar).`);
                    }
                    // 4. Velocidad excesiva (rechazo)
                    else if (segment.velocity > maxVelocityThreshold) {
                        segment.status = "rejected";
                        segment.warnings.push(`Velocidad del gas (${segment.velocity.toFixed(2)} m/s) supera el límite seguro (${maxVelocityThreshold} m/s).`);
                        // showAlert("danger", `Tramo ${segment.startNode}-${segment.endNode}: Velocidad del gas (${segment.velocity.toFixed(2)} m/s) supera el límite seguro (${maxVelocityThreshold} m/s).`);
                    }
                    // 5. Presión final en el límite (aprobado con advertencia, solo para baja presión)
                    else if (currentProject.pressureLevel === 'low' && segment.finalPressure <= 20.00 && segment.finalPressure > minFinalPressureThreshold) {
                        segment.status = "approved-with-warning";
                        segment.warnings.push(`Presión final en el límite (${segment.finalPressure.toFixed(2)} mbar). Validar demanda total.`);
                        // showAlert("warning", `Tramo ${segment.startNode}-${segment.endNode}: Presión final en el límite (20 mbar). Revisar condiciones de carga.`);
                    }
                    // Si no hay rechazos ni advertencias, se aprueba
                    else {
                        segment.status = "approved";
                    }
                    // --- Fin de la lógica de validación ---

                    if (segment.status === "approved" || segment.status === "approved-with-warning") {
                        approvedCount++;
                    }

                    // Actualizar la presión del nodo final con la presión final del segmento.
                    // Si múltiples segmentos terminan en el mismo nodo, se toma la presión más baja
                    // (representando el peor escenario en ese nodo de confluencia).
                    const existingNodePressure = nodePressures.get(segment.endNode);
                    if (existingNodePressure === undefined || segment.finalPressure < existingNodePressure) {
                        nodePressures.set(segment.endNode, segment.finalPressure);
                    }

                    // Actualizar estadísticas generales del proyecto
                    totalLossOverall += pressureLoss;
                    maxVelocityOverall = Math.max(maxVelocityOverall, segment.velocity);

                    // La presión final general es la presión final del último tramo en el orden topológico
                    if (index === segments.length - 1) {
                        finalPressureOverall = segment.finalPressure;
                    }

                    // Log de valores calculados para depuración
                    console.log(`Tramo ${segment.startNode}-${segment.endNode}:`);
                    console.log(`  Pi: ${segment.initialPressure.toFixed(2)} mbar`);
                    console.log(`  Pérdida: ${segment.pressureLoss.toFixed(2)} mbar`);
                    console.log(`  Pf: ${segment.finalPressure.toFixed(2)} mbar`);
                    console.log(`  Velocidad: ${segment.velocity.toFixed(2)} m/s`);
                    console.log(`  Estado: ${segment.status}`);
                });

                renderTable(); // Renderiza la tabla de resultados con el array `segments` ya ordenado
                updateSummary(initialPressureOverall, finalPressureOverall, totalLossOverall, maxVelocityOverall, approvedCount); // Actualiza el resumen
                updateChart(); // Actualiza los gráficos
                saveDataToLocalStorage(); // Guarda los datos
            } catch (error) {
                console.error("Error en calculateNetwork:", error);
                showAlert("danger", `Error en cálculo: ${error.message}`);

                // Marcar todos los segmentos como rechazados en caso de error crítico
                segments.forEach(s => {
                    s.status = "rejected";
                    s.warnings = [error.message]; // Asigna el mensaje de error para visibilidad
                    s.initialPressure = 0; // Resetear valores para evitar NaN en display
                    s.finalPressure = 0;
                    s.pressureLoss = 0;
                    s.velocity = 0;
                });
                renderTable();
                updateSummary();
                updateChart();
            }
        }

        /**
         * Calcula la pérdida de presión (ΔP) utilizando la fórmula adecuada según el nivel de presión.
         * @param {string} pressureLevel - Nivel de presión ('low', 'medium', 'high').
         * @param {number} Q - Caudal en m³/h.
         * @param {number} Leq - Longitud equivalente en metros.
         * @param {number} Dm_meters - Diámetro interno en metros.
         * @param {number} specificGravity - Gravedad específica del gas.
         * @param {number} initialPressure_mbar - Presión inicial del tramo en mbar (manométrica).
         * @returns {number} La pérdida de presión en mbar.
         */
        function calculatePressureLoss(pressureLevel, Q, Leq, Dm_meters, specificGravity, initialPressure_mbar) {
            const Dmm = Dm_meters * 1000; // Convertir Dm a mm para la fórmula de Renouard
            const T_abs = 288.15; // Temperatura absoluta en Kelvin (15°C)
            const P_atm_mbar = 1013.25; // Presión atmosférica estándar en mbar

            // Validación básica para evitar división por cero u operaciones inválidas
            if (Q <= 0 || Leq <= 0 || Dm_meters <= 0 || initialPressure_mbar <= 0) {
                // Si los datos de entrada son inválidos para el cálculo, se asume una pérdida total
                // Esto hará que el tramo sea rechazado en la validación posterior.
                return initialPressure_mbar;
            }

            if (pressureLevel === 'low') {
                // Fórmula Simplificada de Renouard (para baja presión)
                // ΔP (mbar) = (K * S * Leq * Q^1.82) / D^4.82
                // K: Constante (ajustada para mbar, D en mm), S: Gravedad Específica, Leq: m, Q: m³/h, D: mm
                // La constante 26400 ha sido ajustada para que coincida con los resultados del documento externo del usuario.
                const RENOUARD_CONSTANT_MBAR = 26400;
                return (RENOUARD_CONSTANT_MBAR * specificGravity * Leq * Math.pow(Q, 1.82)) / Math.pow(Dmm, 4.82);
            } else if (pressureLevel === 'medium') {
                // Fórmula Panhandle A (para media presión)
                // Q = 0.371 * D^2.618 * [(P1^2 - P2^2) / (S * T * Leq)]^0.5394
                // Resolviendo para (P1^2 - P2^2) y luego ΔP
                // P1 y P2 deben estar en mbar absolutos. Leq en km.
                const P1_abs_mbar = initialPressure_mbar + P_atm_mbar; // Presión inicial absoluta en mbar
                const Leq_km = Leq / 1000; // Longitud equivalente en km

                const term_numerator = Math.pow(Q, (1 / 0.5394));
                const term_denominator = Math.pow(0.371, (1 / 0.5394)) * Math.pow(Dm_meters, (2.618 / 0.5394));
                const P1_sq_minus_P2_sq = (term_numerator / term_denominator) * specificGravity * T_abs * Leq_km;

                const P2_abs_sq = Math.pow(P1_abs_mbar, 2) - P1_sq_minus_P2_sq;
                const P2_abs_mbar = Math.sqrt(Math.max(0, P2_abs_sq)); // Asegurar valor no negativo para raíz cuadrada

                return P1_abs_mbar - P2_abs_mbar; // Pérdida de presión en mbar
            } else if (pressureLevel === 'high') {
                // Fórmula Panhandle B (para alta presión)
                // Q = 0.028 * D^2.665 * [(P1^2 - P2^2) / (S * T * Leq)]^0.51
                // Resolviendo para (P1^2 - P2^2) y luego ΔP
                // P1 y P2 deben estar en Pascales. Leq en km.
                const P1_abs_Pa = (initialPressure_mbar * 100) + (P_atm_mbar * 100); // Presión inicial absoluta en Pascales
                const Leq_km = Leq / 1000; // Longitud equivalente en km

                const term_numerator = Math.pow(Q, (1 / 0.51));
                const term_denominator = Math.pow(0.028, (1 / 0.51)) * Math.pow(Dm_meters, (2.665 / 0.51));
                const P1_sq_minus_P2_sq = (term_numerator / term_denominator) * specificGravity * T_abs * Leq_km;

                const P2_abs_sq = Math.pow(P1_abs_Pa, 2) - P1_sq_minus_P2_sq;
                const P2_abs_Pa = Math.sqrt(Math.max(0, P2_abs_sq)); // Asegurar valor no negativo

                return (P1_abs_Pa - P2_abs_Pa) / 100; // Pérdida de presión en mbar
            }
            return 0; // Si el nivel de presión no es reconocido
        }

        // --- Funciones de renderizado y actualización de UI ---
        /**
         * Renderiza la tabla de resultados con los datos de los segmentos.
         */
        function renderTable() {
            const tbody = document.getElementById("resultsTableBody");
            if (!tbody) return; // Safeguard

            tbody.innerHTML = ""; // Limpia la tabla

            if (segments.length === 0) {
                const emptyRow = document.createElement("tr");
                emptyRow.innerHTML = `<td colspan="12" class="text-center text-muted">No hay tramos registrados.</td>`;
                tbody.appendChild(emptyRow);
                return;
            }

            segments.forEach((segment, i) => {
                const row = document.createElement("tr");
                row.classList.add(
                    segment.status === "approved" ? "segment-approved" :
                    segment.status === "approved-with-warning" ? "segment-approved-with-warning" :
                    "segment-rejected"
                );

                let statusHtml = '';
                if (segment.status === "approved-with-warning") {
                    // Muestra el título de la advertencia en el tooltip
                    statusHtml = `
                        <span class="status-badge status-approved-with-warning" title="${segment.warnings.join('. ')}">
                            <i class="bi bi-exclamation-triangle"></i>
                            Aprobado (Advertencia)
                        </span>
                    `;
                } else if (segment.status === "approved") {
                    statusHtml = `
                        <span class="status-badge status-approved">
                            <i class="bi bi-check-circle"></i>
                            Aprobado
                        </span>
                    `;
                } else { // rejected
                    statusHtml = `
                        <span class="status-badge status-rejected" title="${segment.warnings.join('. ')}">
                            <i class="bi bi-x-circle"></i>
                            Rechazado
                        </span>
                    `;
                }

                // Determinar si mostrar N/A para valores calculados
                const isDisconnected = segment.status === "rejected" && segment.warnings.includes("Nodo de inicio sin presión definida (tramo desconectado).");
                const piDisplay = isDisconnected ? "N/A" : segment.initialPressure.toFixed(2);
                const pfDisplay = isDisconnected ? "N/A" : segment.finalPressure.toFixed(2);
                const lossDisplay = isDisconnected ? "N/A" : segment.pressureLoss.toFixed(2);
                const velocityDisplay = isDisconnected ? "N/A" : segment.velocity.toFixed(2);


                row.innerHTML = `
                    <td class="fw-bold">${segment.id}</td>
                    <td>${segment.startNode}</td>
                    <td>${segment.endNode}</td>
                    <td>${segment.flowRate.toFixed(2)}</td>
                    <td>${segment.length.toFixed(2)}</td>
                    <td>${segment.diameter.toFixed(2)}</td>
                    <td>${piDisplay}</td>
                    <td>${lossDisplay}</td>
                    <td>${pfDisplay}</td>
                    <td>${velocityDisplay}</td>
                    <td>${statusHtml}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editSegment(${i})" aria-label="Editar tramo ${i + 1}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteSegment(${i})" aria-label="Eliminar tramo ${i + 1}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * Actualiza la sección de resumen técnico con los datos calculados.
         * @param {number} initialPressure - Presión inicial global.
         * @param {number} finalPressure - Presión final global.
         * @param {number} totalLoss - Pérdida total de presión.
         * @param {number} maxVelocity - Velocidad máxima en la red.
         * @param {number} approvedCount - Número de tramos aprobados.
         */
        function updateSummary(initialPressure = 0, finalPressure = 0, totalLoss = 0, maxVelocity = 0, approvedCount = 0) {
            const totalSegments = segments.length;
            // Contar solo los segmentos que son 'approved' o 'approved-with-warning'
            const actualApprovedCount = segments.filter(s => s.status === 'approved' || s.status === 'approved-with-warning').length;
            const percentApproved = totalSegments > 0 ? Math.round((actualApprovedCount / totalSegments) * 100) : 0;


            const summaryInitialPressureEl = document.getElementById('summaryInitialPressure');
            if (summaryInitialPressureEl) summaryInitialPressureEl.textContent = initialPressure.toFixed(2);

            const summaryFinalPressureEl = document.getElementById('summaryFinalPressure');
            if (summaryFinalPressureEl) summaryFinalPressureEl.textContent = finalPressure.toFixed(2);
            
            const summaryTotalLossEl = document.getElementById('summaryTotalLoss');
            if (summaryTotalLossEl) summaryTotalLossEl.textContent = totalLoss.toFixed(2);
            
            const summaryMaxVelocityEl = document.getElementById('summaryMaxVelocity');
            if (summaryMaxVelocityEl) summaryMaxVelocityEl.textContent = maxVelocity.toFixed(2);
            
            const summaryApprovedSegmentsEl = document.getElementById('summaryApprovedSegments');
            if (summaryApprovedSegmentsEl) summaryApprovedSegmentsEl.textContent = actualApprovedCount;
            
            const summaryTotalSegmentsEl = document.getElementById('summaryTotalSegments');
            if (summaryTotalSegmentsEl) summaryTotalSegmentsEl.textContent = totalSegments;

            const statusEl = document.getElementById('summaryStatus');
            if (statusEl) {
                if (totalSegments > 0) {
                    let statusText, statusClass;
                    if (percentApproved === 100) {
                        statusText = `<i class="bi bi-check-circle-fill me-1"></i> APROBADO (100%)`;
                        statusClass = "badge bg-success";
                    } else if (percentApproved >= 80) {
                        statusText = `<i class="bi bi-exclamation-triangle-fill me-1"></i> CONDICIONAL (${percentApproved}%)`;
                        statusClass = "badge bg-warning text-dark";
                    } else {
                        statusText = `<i class="bi bi-x-circle-fill me-1"></i> RECHAZADO (${percentApproved}%)`;
                        statusClass = "badge bg-danger";
                    }
                    statusEl.innerHTML = `<span class="${statusClass}">${statusText}</span>`;
                } else {
                    statusEl.textContent = "-";
                }
            }
        }

        /**
         * Actualiza el gráfico de presión y velocidad.
         */
        function updateChart() {
            const chartCanvas = document.getElementById('pressureChart');
            if (!chartCanvas) return; // Safeguard

            const ctx = chartCanvas.getContext('2d');

            if (pressureChart) {
                pressureChart.destroy(); // Destruye la instancia anterior del gráfico
            }

            const labels = segments.map(seg => `${seg.startNode}-${seg.endNode}`);
            // Filtrar valores para el gráfico: si es "N/A" (desconectado), no se grafica
            const pressures = segments.map(seg => seg.status === "rejected" && seg.warnings.includes("Nodo de inicio sin presión definida (tramo desconectado).") ? NaN : seg.finalPressure);
            const velocities = segments.map(seg => seg.status === "rejected" && seg.warnings.includes("Nodo de inicio sin presión definida (tramo desconectado).") ? NaN : seg.velocity);


            pressureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Presión (mbar)',
                            data: pressures,
                            borderColor: '#e74c3c', // Rojo
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 3,
                            tension: 0.3, // Curva suave
                            yAxisID: 'y',
                            pointBackgroundColor: '#e74c3c',
                            pointRadius: 5,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Velocidad (m/s)',
                            data: velocities,
                            borderColor: '#3498db', // Azul
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 3,
                            tension: 0.3,
                            yAxisID: 'y1',
                            pointBackgroundColor: '#3498db',
                            pointRadius: 5,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false // Muestra tooltips para todos los datasets en el punto
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Perfil de Presión y Velocidad',
                            font: { size: 18, weight: 'bold' },
                            padding: { top: 10, bottom: 20 }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 13 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(44, 62, 80, 0.95)',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 12 },
                            padding: 12,
                            usePointStyle: true,
                            callbacks: {
                                label: function (context) {
                                    if (isNaN(context.parsed.y)) {
                                        return `${context.dataset.label}: N/A`;
                                    }
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Presión (mbar)',
                                font: { weight: 'bold' }
                            },
                            min: Math.max(0, Math.min(...pressures.filter(v => !isNaN(v))) - 5), // Ajusta el mínimo del eje
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Velocidad (m/s)',
                                font: { weight: 'bold' }
                            },
                            min: 0,
                            max: Math.max(10, Math.max(...velocities.filter(v => !isNaN(v))) + 2), // Ajusta el máximo del eje
                            grid: { drawOnChartArea: false } // No dibuja la cuadrícula para este eje
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tramos de la Red',
                                font: { weight: 'bold' }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        }
                    }
                }
            });
        }

        // --- Funciones de vista previa del informe PDF ---
        /**
         * Actualiza toda la vista previa del informe en la pestaña "Informe".
         */
        function updateReportPreview() {
            updateBasicInfoPreview();
            updateTechnicalConfigPreview();
            updateTechnicalSummaryPreview();
            updateSegmentsPreview();
            updatePreviewChart();
        }

        /**
         * Actualiza la información básica del cliente y proyecto en la vista previa.
         */
        function updateBasicInfoPreview() {
            const previewProjectNameEl = document.getElementById('previewProjectName');
            if (previewProjectNameEl) previewProjectNameEl.textContent = currentProject.name || "Sin nombre";

            const previewClientNameEl = document.getElementById('previewClientName');
            if (previewClientNameEl) previewClientNameEl.textContent = currentClient.name || "-";

            const previewClientIdEl = document.getElementById('previewClientId');
            if (previewClientIdEl) previewClientIdEl.textContent = currentClient.id || "-";

            const previewClientPhoneEl = document.getElementById('previewClientPhone');
            if (previewClientPhoneEl) previewClientPhoneEl.textContent = currentClient.phone || "-";

            const previewClientEmailEl = document.getElementById('previewClientEmail');
            if (previewClientEmailEl) previewClientEmailEl.textContent = currentClient.email || "-";

            const previewClientAddressEl = document.getElementById('previewClientAddress');
            if (previewClientAddressEl) previewClientAddressEl.textContent = currentClient.address || "-";

            const previewClientCityEl = document.getElementById('previewClientCity');
            if (previewClientCityEl) previewClientCityEl.textContent = currentClient.city || "-";

            const previewProjectTypeEl = document.getElementById('previewProjectType');
            if (previewProjectTypeEl) previewProjectTypeEl.textContent = currentClient.projectType || "-";

            const previewProjectNotesEl = document.getElementById('previewProjectNotes');
            if (previewProjectNotesEl) previewProjectNotesEl.textContent = currentClient.projectNotes || "No se registraron observaciones adicionales.";
        }

        /**
         * Actualiza la configuración técnica en la vista previa.
         */
        function updateTechnicalConfigPreview() {
            const previewGasTypeEl = document.getElementById('previewGasType');
            if (previewGasTypeEl) previewGasTypeEl.textContent = CONFIG.gases[currentProject.gasType].name;

            const previewPressureLevelEl = document.getElementById('previewPressureLevel');
            if (previewPressureLevelEl) previewPressureLevelEl.textContent = CONFIG.pressures[currentProject.pressureLevel].name;

            const previewMaterialEl = document.getElementById('previewMaterial');
            if (previewMaterialEl) previewMaterialEl.textContent = CONFIG.materials[currentProject.material].name;

            const previewInitialPressureEl = document.getElementById('previewInitialPressure');
            if (previewInitialPressureEl) previewInitialPressureEl.textContent = currentProject.initialPressure.toFixed(2);

            const previewFormulaEl = document.getElementById('previewFormula');
            if (previewFormulaEl) previewFormulaEl.textContent = CONFIG.pressures[currentProject.pressureLevel].formula;

            const previewSegmentCountEl = document.getElementById('previewSegmentCount');
            if (previewSegmentCountEl) previewSegmentCountEl.textContent = segments.length;
        }

        /**
         * Actualiza el resumen técnico en la vista previa, tomando los valores del resumen principal.
         */
        function updateTechnicalSummaryPreview() {
            const previewSummaryInitialPressureEl = document.getElementById('previewSummaryInitialPressure');
            if (previewSummaryInitialPressureEl) previewSummaryInitialPressureEl.textContent = document.getElementById('summaryInitialPressure').textContent;

            const previewSummaryFinalPressureEl = document.getElementById('previewSummaryFinalPressure');
            if (previewSummaryFinalPressureEl) previewSummaryFinalPressureEl.textContent = document.getElementById('summaryFinalPressure').textContent;

            const previewSummaryTotalLossEl = document.getElementById('previewSummaryTotalLoss');
            if (previewSummaryTotalLossEl) previewSummaryTotalLossEl.textContent = document.getElementById('summaryTotalLoss').textContent;

            const previewSummaryMaxVelocityEl = document.getElementById('previewSummaryMaxVelocity');
            if (previewSummaryMaxVelocityEl) previewSummaryMaxVelocityEl.textContent = document.getElementById('summaryMaxVelocity').textContent;

            const previewSummaryApprovedSegmentsEl = document.getElementById('previewSummaryApprovedSegments');
            if (previewSummaryApprovedSegmentsEl) previewSummaryApprovedSegmentsEl.textContent = document.getElementById('summaryApprovedSegments').textContent;

            const previewSummaryTotalSegmentsEl = document.getElementById('previewSummaryTotalSegments');
            if (previewSummaryTotalSegmentsEl) previewSummaryTotalSegmentsEl.textContent = document.getElementById('summaryTotalSegments').textContent;

            const previewSummaryStatusEl = document.getElementById('previewSummaryStatus');
            if (previewSummaryStatusEl) previewSummaryStatusEl.innerHTML = document.getElementById('summaryStatus').innerHTML;
        }

        /**
         * Actualiza la tabla de detalle de tramos en la vista previa del informe.
         */
        function updateSegmentsPreview() {
            const previewTbody = document.getElementById('previewResultsTable');
            if (!previewTbody) return; // Safeguard

            previewTbody.innerHTML = '';

            segments.forEach(segment => {
                const tr = document.createElement('tr');
                // Determinar si mostrar N/A para valores calculados
                const isDisconnected = segment.status === "rejected" && segment.warnings.includes("Nodo de inicio sin presión definida (tramo desconectado).");
                const piDisplay = isDisconnected ? "N/A" : segment.initialPressure.toFixed(2);
                const pfDisplay = isDisconnected ? "N/A" : segment.finalPressure.toFixed(2);
                const velocityDisplay = isDisconnected ? "N/A" : segment.velocity.toFixed(2);

                tr.innerHTML = `
                    <td>${segment.id}</td>
                    <td>${segment.startNode}</td>
                    <td>${segment.endNode}</td>
                    <td>${segment.flowRate.toFixed(2)}</td>
                    <td>${segment.length.toFixed(2)}</td>
                    <td>${segment.diameter.toFixed(2)}</td>
                    <td>${piDisplay}</td>
                    <td>${pfDisplay}</td>
                    <td>${velocityDisplay}</td>
                    <td style="color: ${segment.status === 'approved' || segment.status === 'approved-with-warning' ? '#4CAF50' : '#F44336'}; font-weight: bold;">
                        ${segment.status === 'approved' ? 'Aprobado' : (segment.status === 'approved-with-warning' ? 'Aprobado (Advertencia)' : 'Rechazado')}
                    </td>
                `;
                previewTbody.appendChild(tr);
            });
        }

        /**
         * Actualiza el gráfico de la vista previa del informe.
         */
        function updatePreviewChart() {
            const container = document.getElementById('previewChartContainer');
            const canvas = document.getElementById('previewChart');

            if (!container || !canvas) {
                // console.warn("Preview chart container or canvas not found.");
                return; // Safely exit if elements not found
            }

            // Asegura que el canvas tenga el tamaño correcto para el renderizado
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            const ctx = canvas.getContext('2d');

            if (previewChart) {
                previewChart.destroy(); // Destruye la instancia anterior
            }

            if (segments.length === 0) {
                // Muestra un mensaje si no hay datos
                ctx.font = '14px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos disponibles para mostrar',
                    canvas.width / 2, canvas.height / 2);
                return;
            }

            // Muestra solo un subconjunto de etiquetas si hay muchos segmentos para evitar aglomeración
            const step = Math.max(1, Math.floor(segments.length / 20));
            const labels = [];
            const pressures = [];
            const velocities = [];

            for (let i = 0; i < segments.length; i += step) {
                labels.push(`${segments[i].startNode}-${segments[i].endNode}`);
                // Filtrar valores para el gráfico: si es "N/A" (desconectado), no se grafica
                pressures.push(segments[i].status === "rejected" && segments[i].warnings.includes("Nodo de inicio sin presión definida (tramo desconectado).") ? NaN : segments[i].finalPressure);
                velocities.push(segments[i].status === "rejected" && segments[i].warnings.includes("Nodo de inicio sin presión definida (tramo desconectado).") ? NaN : segments[i].velocity);
            }

            // Asegura que el último segmento siempre se incluya
            if (segments.length > 0 && (segments.length - 1) % step !== 0) {
                const last = segments.length - 1;
                labels.push(`${segments[last].startNode}-${segments[last].endNode}`);
                pressures.push(segments[last].status === "rejected" && segments[last].warnings.includes("Nodo de inicio sin presión definida (tramo desconectado).") ? NaN : segments[last].finalPressure);
                velocities.push(segments[last].status === "rejected" && segments[last].warnings.includes("Nodo de inicio sin presión definida (tramo desconectado).") ? NaN : segments[last].velocity);
            }

            previewChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Presión (mbar)',
                            data: pressures,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            yAxisID: 'y',
                            pointBackgroundColor: '#e74c3c',
                            pointRadius: 3
                        },
                        {
                            label: 'Velocidad (m/s)',
                            data: velocities,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            yAxisID: 'y1',
                            pointBackgroundColor: '#3498db',
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                padding: 20,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (isNaN(context.parsed.y)) {
                                        return `${context.dataset.label}: N/A`;
                                    }
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Presión (mbar)',
                                font: { weight: 'bold' }
                            },
                            min: Math.max(0, Math.min(...pressures.filter(v => !isNaN(v))) * 0.95),
                            max: Math.max(...pressures.filter(v => !isNaN(v))) * 1.05
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Velocidad (m/s)',
                                font: { weight: 'bold' }
                            },
                            min: 0,
                            max: Math.max(10, Math.max(...velocities.filter(v => !isNaN(v))) * 1.2)
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 15 // Limita el número de etiquetas en el eje X
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // --- Funciones de exportación a PDF ---
        /**
         * Exporta el informe completo a un archivo PDF de forma profesional.
         */
        async function exportToPDF() {
            try {
                if (!segments || segments.length === 0) {
                    showAlert("warning", "No hay datos de tramos para exportar.");
                    return;
                }

                showAlert("info", "Generando informe profesional...");

                // Pequeña pausa para asegurar que la UI se actualice
                await new Promise(resolve => setTimeout(resolve, 500));

                // Inicializa jsPDF
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    putOnlyUsedFonts: true,
                    hotfixes: ["px_scaling"]
                });

                const margin = 15; // Márgenes del documento
                let currentY = margin; // Posición Y actual para el contenido
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const contentWidth = pageWidth - 2 * margin;

                // Define estilos para el contenido del PDF
                const styles = {
                    title: { size: 18, color: [26, 75, 140], fontStyle: 'bold' },
                    header: { size: 14, color: [26, 75, 140], fontStyle: 'bold' },
                    subheader: { size: 12, color: [51, 51, 51], fontStyle: 'normal' },
                    body: { size: 10, color: [68, 68, 68], fontStyle: 'normal' },
                    small: { size: 8, color: [100, 100, 100], fontStyle: 'normal' }
                };

                /**
                 * Añade texto al PDF con el estilo y la posición especificados.
                 * @param {string|string[]} text - El contenido de texto (puede ser un array para múltiples líneas).
                 * @param {object} style - El objeto de estilo (size, color, fontStyle).
                 * @param {number} x - Coordenada X.
                 * @param {number} y - Coordenada Y.
                 * @param {string} align - Alineación del texto ('left', 'center', 'right').
                 * @returns {number} La nueva posición Y después de añadir el texto.
                 */
                function addText(text, style, x, y, align = 'left') {
                    doc.setFont('helvetica', style.fontStyle);
                    doc.setFontSize(style.size);
                    doc.setTextColor(style.color[0], style.color[1], style.color[2]);
                    doc.text(text, x, y, { align });
                    // Calcular la altura del texto añadido para actualizar currentY
                    const textHeight = Array.isArray(text) ? text.length * (style.size / 2 + 2) : (style.size / 2 + 2);
                    return y + textHeight;
                }

                /**
                 * Verifica si hay suficiente espacio para nuevo contenido y añade una nueva página si es necesario.
                 * @param {number} neededSpace - El espacio vertical requerido para el siguiente bloque de contenido.
                 * @returns {boolean} True si se añadió una nueva página, false en caso contrario.
                 */
                function checkPageBreak(neededSpace) {
                    if (currentY + neededSpace > pageHeight - margin) {
                        doc.addPage();
                        currentY = margin;
                        return true;
                    }
                    return false;
                }

                // --- Generación del Contenido del PDF ---

                // Encabezado
                currentY = addText('INFORME TÉCNICO DE RED DE GAS', styles.title, pageWidth / 2, currentY, 'center');
                currentY = addText(`Proyecto: ${currentProject.name || 'Sin nombre'} | Fecha: ${new Date().toLocaleDateString('es-CO')}`, styles.subheader, pageWidth / 2, currentY, 'center');
                currentY += 5;
                doc.setDrawColor(styles.title.color[0], styles.title.color[1], styles.title.color[2]); // Azul primario
                doc.setLineWidth(0.5);
                doc.line(margin, currentY, pageWidth - margin, currentY); // Línea horizontal
                currentY += 10;

                // 1. Información del Cliente
                checkPageBreak(40); // Estimar espacio para esta sección
                currentY = addText('1. INFORMACIÓN DEL CLIENTE', styles.header, margin, currentY);
                currentY += 5;

                doc.setFont('helvetica', styles.body.fontStyle);
                doc.setFontSize(styles.body.size);
                doc.setTextColor(styles.body.color[0], styles.body.color[1], styles.body.color[2]);

                doc.text(`Nombre: ${currentClient.name || '-'}`, margin, currentY);
                doc.text(`Identificación: ${currentClient.id || '-'}`, margin + contentWidth / 2, currentY);
                currentY += 6;
                doc.text(`Teléfono: ${currentClient.phone || '-'}`, margin, currentY);
                doc.text(`Correo Electrónico: ${currentClient.email || '-'}`, margin + contentWidth / 2, currentY);
                currentY += 6;
                doc.text(`Dirección: ${currentClient.address || '-'}`, margin, currentY);
                doc.text(`Ciudad: ${currentClient.city || '-'}`, margin + contentWidth / 2, currentY);
                currentY += 6;
                doc.text(`Departamento: ${currentClient.department || '-'}`, margin, currentY);
                doc.text(`Tipo de Proyecto: ${currentClient.projectType || '-'}`, margin + contentWidth / 2, currentY);
                currentY += 10;

                // 2. Configuración Técnica
                checkPageBreak(30); // Estimar espacio
                currentY = addText('2. CONFIGURACIÓN TÉCNICA', styles.header, margin, currentY);
                currentY += 5;

                doc.setFont('helvetica', styles.body.fontStyle);
                doc.setFontSize(styles.body.size);
                doc.setTextColor(styles.body.color[0], styles.body.color[1], styles.body.color[2]);

                doc.text(`Tipo de Gas: ${CONFIG.gases[currentProject.gasType].name}`, margin, currentY);
                doc.text(`Nivel de Presión: ${CONFIG.pressures[currentProject.pressureLevel].name}`, margin + contentWidth / 2, currentY);
                currentY += 6;
                doc.text(`Material de Tubería: ${CONFIG.materials[currentProject.material].name}`, margin, currentY);
                doc.text(`Presión Inicial (Pi): ${currentProject.initialPressure.toFixed(2)} mbar`, margin + contentWidth / 2, currentY);
                currentY += 6;
                doc.text(`Fórmula Aplicada: ${CONFIG.pressures[currentProject.pressureLevel].formula}`, margin, currentY);
                doc.text(`Tramos Calculados: ${segments.length}`, margin + contentWidth / 2, currentY);
                currentY += 10;

                // 3. Resumen Técnico
                checkPageBreak(40); // Estimar espacio
                currentY = addText('3. RESUMEN TÉCNICO', styles.header, margin, currentY);
                currentY += 5;

                doc.setFont('helvetica', styles.body.fontStyle);
                doc.setFontSize(styles.body.size);
                doc.setTextColor(styles.body.color[0], styles.body.color[1], styles.body.color[2]);

                // Obtener valores de resumen de los elementos de la UI (ya actualizados por updateSummary)
                const summaryInitialPressure = document.getElementById('summaryInitialPressure').textContent;
                const summaryFinalPressure = document.getElementById('summaryFinalPressure').textContent;
                const summaryTotalLoss = document.getElementById('summaryTotalLoss').textContent;
                const summaryMaxVelocity = document.getElementById('summaryMaxVelocity').textContent;
                const summaryApprovedSegments = document.getElementById('summaryApprovedSegments').textContent;
                const summaryTotalSegments = document.getElementById('summaryTotalSegments').textContent;
                const summaryStatusHTML = document.getElementById('summaryStatus').innerHTML; // Contiene HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = summaryStatusHTML;
                const summaryStatusText = tempDiv.textContent || tempDiv.innerText;

                doc.text(`Presión Inicial: ${summaryInitialPressure} mbar`, margin, currentY);
                doc.text(`Presión Final: ${summaryFinalPressure} mbar`, margin + contentWidth / 2, currentY);
                currentY += 6;
                doc.text(`Pérdida Total: ${summaryTotalLoss} mbar`, margin, currentY);
                doc.text(`Velocidad Máxima: ${summaryMaxVelocity} m/s`, margin + contentWidth / 2, currentY);
                currentY += 6;
                doc.text(`Tramos Aprobados: ${summaryApprovedSegments} de ${summaryTotalSegments}`, margin, currentY);
                doc.text(`Estado General: ${summaryStatusText}`, margin + contentWidth / 2, currentY);
                currentY += 10;

                // 4. Detalle de Tramos (Tabla)
                checkPageBreak(50); // Estimar espacio para encabezado y primeras filas
                currentY = addText('4. DETALLE DE TRAMOS', styles.header, margin, currentY);
                currentY += 5;

                const tableHeaders = [
                    '#', 'Desde', 'Hasta', 'Caudal (m³/h)', 'Long. (m)', 'Diám. (mm)',
                    'Pi (mbar)', 'Pérdida (mbar)', 'Pf (mbar)', 'Veloc. (m/s)', 'Estado'
                ];

                const tableRows = segments.map(seg => {
                    const isDisconnected = seg.status === "rejected" && seg.warnings.includes("Nodo de inicio sin presión definida (tramo desconectado).");
                    const piDisplay = isDisconnected ? "N/A" : seg.initialPressure.toFixed(2);
                    const pfDisplay = isDisconnected ? "N/A" : seg.finalPressure.toFixed(2);
                    const lossDisplay = isDisconnected ? "N/A" : seg.pressureLoss.toFixed(2);
                    const velocityDisplay = isDisconnected ? "N/A" : seg.velocity.toFixed(2);

                    return [
                        seg.id,
                        seg.startNode,
                        seg.endNode,
                        seg.flowRate.toFixed(2),
                        seg.length.toFixed(2),
                        seg.diameter.toFixed(2),
                        piDisplay,
                        lossDisplay,
                        pfDisplay,
                        velocityDisplay,
                        seg.status === 'approved' ? 'Aprobado' : (seg.status === 'approved-with-warning' ? 'Aprobado (Adv.)' : 'Rechazado')
                    ];
                });

                // Usar autoTable para generar la tabla
                doc.autoTable({
                    startY: currentY,
                    head: [tableHeaders],
                    body: tableRows,
                    theme: 'grid',
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 7,
                        cellPadding: 2,
                        halign: 'center',
                        valign: 'middle',
                        textColor: [styles.body.color[0], styles.body.color[1], styles.body.color[2]]
                    },
                    headStyles: {
                        fillColor: [styles.header.color[0], styles.header.color[1], styles.header.color[2]], // Azul primario
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [245, 247, 250] // Gris claro
                    },
                    columnStyles: {
                        0: { cellWidth: 8 }, // #
                        1: { cellWidth: 12 }, // Desde
                        2: { cellWidth: 12 }, // Hasta
                        3: { cellWidth: 18 }, // Caudal
                        4: { cellWidth: 15 }, // Long.
                        5: { cellWidth: 15 }, // Diám.
                        6: { cellWidth: 15 }, // Pi
                        7: { cellWidth: 18 }, // Pérdida
                        8: { cellWidth: 15 }, // Pf
                        9: { cellWidth: 15 }, // Veloc.
                        10: { cellWidth: 20 } // Estado
                    },
                    didDrawPage: function (data) {
                        // Añadir encabezado en páginas subsiguientes si la tabla se extiende
                        if (data.pageNumber > 1 && data.pageCount > 1) {
                            doc.setFont('helvetica', styles.header.fontStyle);
                            doc.setFontSize(styles.header.size);
                            doc.setTextColor(styles.header.color[0], styles.header.color[1], styles.header.color[2]);
                            doc.text('INFORME TÉCNICO DE RED DE GAS (Continuación)', pageWidth / 2, margin, { align: 'center' });
                        }
                        // Pie de página en cada página
                        doc.setFont('helvetica', styles.small.fontStyle);
                        doc.setFontSize(styles.small.size);
                        doc.setTextColor(styles.small.color[0], styles.small.color[1], styles.small.color[2]);
                        doc.text('Documento generado por Todo Gas - Sistema de Cálculo de Redes de Gas', pageWidth / 2, pageHeight - 10, { align: 'center' });
                    }
                });

                currentY = doc.autoTable.previous.finalY + 10; // Actualizar posición Y después de la tabla

                // 5. Gráfico de Presión y Velocidad
                if (segments.length > 0) {
                    const chartExpectedHeight = 90; // Altura estimada para el gráfico
                    checkPageBreak(chartExpectedHeight + 20); // Verificar espacio, añadir nueva página si es necesario

                    currentY = addText('5. GRÁFICO DE PRESIÓN Y VELOCIDAD', styles.header, margin, currentY);
                    currentY += 5;

                    // Aumentar temporalmente devicePixelRatio para captura de gráfico en alta resolución
                    const originalDevicePixelRatio = window.devicePixelRatio;
                    window.devicePixelRatio = 4; // Establecer a 4 para mayor resolución

                    // Volver a renderizar el gráfico con DPI alto
                    if (pressureChart) {
                        pressureChart.destroy();
                    }
                    updateChart(); // Esto volverá a renderizar el gráfico con el nuevo devicePixelRatio

                    // Esperar a que el gráfico se renderice (un poco más de tiempo para estabilidad)
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Increased to 2000ms

                    const chartCanvas = document.getElementById('pressureChart');
                    let chartDataURL = '';
                    try {
                        chartDataURL = chartCanvas.toDataURL('image/png', 1.0); // Capturar con calidad 1.0
                    } catch (captureError) {
                        console.error("Error al capturar el gráfico para PDF:", captureError);
                        showAlert("danger", "Error al capturar el gráfico para el PDF. El informe se generará sin gráfico.");
                        chartDataURL = ''; // Asegurar que no se intente añadir una imagen corrupta
                    }
                    
                    // Restaurar devicePixelRatio original
                    window.devicePixelRatio = originalDevicePixelRatio;
                    if (pressureChart) {
                        pressureChart.destroy();
                    }
                    updateChart(); // Volver a renderizar el gráfico con DPI original para la UI

                    if (chartDataURL) {
                        // Calcular dimensiones de la imagen para que se ajuste al ancho de la página manteniendo la relación de aspecto
                        const imgWidth = contentWidth;
                        const imgHeight = (chartCanvas.height * imgWidth) / chartCanvas.width;

                        doc.addImage(chartDataURL, 'PNG', margin, currentY, imgWidth, imgHeight);
                        currentY += imgHeight + 10;
                    }
                }

                // 6. Observaciones y Firma
                checkPageBreak(60); // Estimar espacio para esta sección
                currentY = addText('6. OBSERVACIONES Y FIRMA', styles.header, margin, currentY);
                currentY += 5;

                doc.setFont('helvetica', styles.body.fontStyle);
                doc.setFontSize(styles.body.size);
                doc.setTextColor(styles.body.color[0], styles.body.color[1], styles.body.color[2]);

                currentY = addText('Observaciones:', styles.subheader, margin, currentY);
                const projectNotes = currentClient.projectNotes || "No se registraron observaciones adicionales.";
                const splitNotes = doc.splitTextToSize(projectNotes, contentWidth);
                currentY = addText(splitNotes, styles.body, margin, currentY); // Usar la función addText para el array de líneas
                currentY += 20; // Ajuste adicional después de las notas

                // Línea de firma
                doc.line(margin + contentWidth / 4, currentY, margin + contentWidth * 3 / 4, currentY);
                currentY += 5;
                currentY = addText('Firma del Responsable Técnico', styles.body, pageWidth / 2, currentY, 'center');
                currentY += 10;

                // Descargo de responsabilidad al final del documento
                doc.setFont('helvetica', 'italic');
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                const disclaimerText = "Este informe es generado por una herramienta de software con fines de diseño y estimación. Los cálculos presentados deben ser verificados y aprobados por un ingeniero o técnico certificado de acuerdo con las normas y regulaciones locales vigentes. TODO GAS SYR S.A.S no asume responsabilidad por el uso de este informe sin la debida validación profesional.";
                const splitDisclaimer = doc.splitTextToSize(disclaimerText, contentWidth);
                currentY = pageHeight - margin - (splitDisclaimer.length * (8 / 2 + 2)); // Posicionar el disclaimer al final de la página
                doc.text(splitDisclaimer, pageWidth / 2, currentY, { align: 'center' });


                // Guardar el PDF
                const fileName = `Informe_Gas_${(currentProject.name || 'SinNombre').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(fileName);

                showAlert("success", "Informe PDF profesional generado con éxito.");
            } catch (error) {
                console.error("Error al generar PDF:", error);
                showAlert("danger", "Error al generar el informe PDF. Detalles: " + error.message);
            }
        }

        // --- Funciones de utilidades (alertas y confirmaciones) ---
        /**
         * Muestra una alerta flotante personalizada en la esquina superior derecha.
         * @param {string} type - Tipo de alerta ('success', 'danger', 'warning', 'info').
         * @param {string} message - Mensaje a mostrar.
         */
        function showAlert(type, message) {
            const alert = document.getElementById('globalAlert');
            const icon = document.getElementById('alertIcon');
            const msg = document.getElementById('alertMessage');

            let iconClass, bgColor;
            switch (type) {
                case 'success':
                    iconClass = 'bi-check-circle-fill';
                    bgColor = 'var(--success)';
                    break;
                case 'danger':
                    iconClass = 'bi-exclamation-triangle-fill';
                    bgColor = 'var(--danger)';
                    break;
                case 'warning':
                    iconClass = 'bi-exclamation-circle-fill';
                    bgColor = 'var(--warning)';
                    break;
                case 'info':
                    iconClass = 'bi-info-circle-fill';
                    bgColor = 'var(--info)';
                    break;
                default:
                    iconClass = 'bi-info-circle-fill';
                    bgColor = 'var(--info)';
            }

            icon.className = 'bi ' + iconClass; // Asigna la clase del icono
            msg.innerHTML = message; // Asigna el mensaje
            alert.style.backgroundColor = bgColor; // Asigna el color de fondo
            alert.classList.add('show'); // Muestra la alerta

            // Oculta la alerta después de 5 segundos
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        /**
         * Muestra un modal de confirmación personalizado.
         * @param {string} message - Mensaje de confirmación.
         * @param {Function} callback - Función a ejecutar si el usuario confirma.
         */
        function showConfirm(message, callback) {
            document.getElementById('confirmModalBody').textContent = message;
            const confirmBtn = document.getElementById('confirmModalBtn');

            // Clona el botón para eliminar listeners anteriores y evitar múltiples ejecuciones
            confirmBtn.replaceWith(confirmBtn.cloneNode(true));
            document.getElementById('confirmModalBtn').onclick = function () {
                confirmModal.hide(); // Oculta el modal
                callback(); // Ejecuta la función de callback
            };

            confirmModal.show(); // Muestra el modal
        }

        // Hace que las funciones sean accesibles globalmente para los eventos onclick en el HTML
        window.editSegment = editSegment;
        window.confirmDeleteSegment = confirmDeleteSegment;
    </script>
</body>

</html>
